<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanzi Creatures - Learn Chinese Characters</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.svg">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="practice-styles.css">
    <script src="https://unpkg.com/hanzi-writer@3.5.0/dist/hanzi-writer.min.js"></script>
    <script>
        // Check if HanziWriter loaded, if not try local fallback
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof HanziWriter === 'undefined') {
                console.log('CDN HanziWriter failed, trying local fallback...');
                const script = document.createElement('script');
                script.src = './hanzi-writer.min.js';
                script.onload = function() {
                    console.log('Local HanziWriter loaded successfully');
                    if (window.game && window.gameUI) {
                        window.gameUI.showMessage('Library loaded! You can now practice characters.', 'success');
                    }
                };
                script.onerror = function() {
                    console.error('Both CDN and local HanziWriter failed');
                    if (window.gameUI) {
                        window.gameUI.showMessage('Failed to load character writing library. Please refresh the page or check your connection.', 'error');
                    } else {
                        // Show basic error if UI isn't loaded yet
                        document.body.innerHTML = '<div style="text-align:center;padding:50px;font-family:Arial;"><h2>‚ö†Ô∏è Loading Error</h2><p>Failed to load the character writing library.<br>Please refresh the page or check your internet connection.</p><button onclick="location.reload()">Refresh Page</button></div>';
                    }
                };
                document.head.appendChild(script);
            } else {
                console.log('HanziWriter loaded from CDN successfully');
            }
        });
    </script>
</head>
<body>
    <div class="game-container">
        <!-- Header with stats -->
        <header class="game-header">
            <div class="player-stats">
                <div class="stat">
                    <span class="stat-label">Level:</span>
                    <span id="player-level">1</span>
                </div>
                <div class="stat">
                    <span class="stat-label">XP:</span>
                    <span id="player-xp">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Characters:</span>
                    <span id="character-count">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Items:</span>
                    <span id="item-count">0</span>
                </div>
            </div>
            <div class="game-controls">
                <button id="items-btn" class="pixel-btn items-btn" title="View and use items">üéí Items</button>
                <button id="battle-btn" class="pixel-btn battle-btn" title="Battle wild characters and phrases!">‚öîÔ∏è Battle</button>
                
                <!-- File Operations Dropdown -->
                <div class="dropdown">
                    <button id="file-menu-btn" class="pixel-btn dropdown-btn" title="File operations">üíæ File</button>
                    <div class="dropdown-content">
                        <button id="save-btn" class="dropdown-item" title="Save to browser (auto-saves anyway)">üíæ Save</button>
                        <button id="export-btn" class="dropdown-item" title="Download backup file">üì§ Export</button>
                        <button id="load-btn" class="dropdown-item" title="Load from backup file">üì• Load</button>
                    </div>
                </div>
                
                <!-- Settings Dropdown -->
                <div class="dropdown">
                    <button id="settings-menu-btn" class="pixel-btn dropdown-btn" title="Game settings">‚öôÔ∏è Settings</button>
                    <div class="dropdown-content">
                        <button id="manage-btn" class="dropdown-item" title="Manage characters and data">üÄÑ Manage Data</button>
                        <button id="game-reset-btn" class="dropdown-item reset-btn" title="Reset all game data (cannot be undone!)">üóëÔ∏è Reset Game</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main game area -->
        <main class="game-main">
            <!-- Character selection screen -->
            <div id="character-select" class="screen active">
                <h2>Choose a Character to Practice</h2>
                <div id="loading-indicator" class="loading-message">
                    <div class="loading-spinner"></div>
                    <p>Loading Hanzi Creatures...</p>
                </div>
                <div id="character-grid" class="character-grid" style="display: none;">
                    <!-- Characters will be dynamically loaded here -->
                </div>
                <button id="add-character-btn" class="pixel-btn" style="display: none;">Add New Character</button>
            </div>

            <!-- Practice screen -->
            <div id="practice-screen" class="screen">
                <div class="practice-header">
                    <button id="back-btn" class="pixel-btn">‚Üê Back</button>
                    <div class="current-character-info">
                        <h3 id="current-character-name">‰Ω†</h3>
                        <div class="character-stats">
                            <span>Level: <span id="char-level">1</span></span>
                            <span>XP: <span id="char-xp">0/100</span></span>
                            <span>HP: <span id="char-hp">20</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="practice-area">
                    <!-- Hanzi writing area -->
                    <div id="hanzi-writer" class="hanzi-container"></div>
                    
                    <!-- Practice controls -->
                    <div class="practice-controls">
                        <button id="hint-btn" class="pixel-btn">Show Hint</button>
                        <button id="reset-btn" class="pixel-btn">Reset</button>
                        <button id="next-btn" class="pixel-btn">Next Practice</button>
                    </div>
                </div>

                <!-- XP feedback -->
                <div id="xp-feedback" class="xp-feedback hidden">
                    <div class="xp-gained">+<span id="xp-amount">0</span> XP!</div>
                    <div class="accuracy">Accuracy: <span id="accuracy-percent">0</span>%</div>
                </div>
            </div>

            <!-- Character management screen -->
            <div id="manage-screen" class="screen">
                <h2>Manage Game</h2>
                
                <!-- Data Management Section -->
                <div class="manage-section">
                    <h3>üìö Game Data</h3>
                    <div class="data-status" id="data-status">
                        <p>Current Data Source: <span id="current-data-source">Built-in</span></p>
                        <p>Characters: <span id="data-char-count">0</span> | Phrases: <span id="data-phrase-count">0</span></p>
                    </div>
                    
                    <div class="data-controls">
                        <div class="upload-area" id="upload-area">
                            <div class="upload-content">
                                <div class="upload-icon">üìÅ</div>
                                <p>Drop JSON files here or <button class="link-btn" id="browse-files">browse files</button></p>
                                <small>Supports character data, phrase data, or combined JSON files</small>
                            </div>
                            <input type="file" id="file-input" accept=".json" multiple style="display: none;">
                        </div>
                        
                        <div class="data-buttons">
                            <button id="switch-to-builtin" class="pixel-btn" title="Use built-in game data">üì¶ Use Built-in Data</button>
                            <button id="switch-to-custom" class="pixel-btn" title="Use your custom uploaded data" disabled>üìù Use Custom Data</button>
                            <button id="export-custom-data" class="pixel-btn" title="Download your custom data as JSON">üíæ Export Custom Data</button>
                            <button id="clear-custom-data" class="pixel-btn warning-btn" title="Delete all custom data">üóëÔ∏è Clear Custom Data</button>
                            <button id="show-examples" class="pixel-btn" title="Show example JSON formats">üìã Show Examples</button>
                        </div>
                    </div>
                </div>

                <!-- Character Management Section -->
                <div class="manage-section">
                    <h3>üÄÑ Character Management</h3>
                    <div class="manage-controls">
                        <div class="input-row">
                            <input type="text" id="new-character-input" placeholder="Character (e.g., ‰Ω†)" maxlength="1">
                            <input type="text" id="new-pinyin-input" placeholder="Pinyin (e.g., n«ê)" maxlength="10">
                        </div>
                        <button id="add-char-btn" class="pixel-btn">Add Character</button>
                    </div>
                    <div id="manage-grid" class="character-grid">
                        <!-- Managed characters will appear here -->
                    </div>
                </div>

                <button id="back-to-select" class="pixel-btn">Back to Game</button>
            </div>

            <!-- Evolution/Phrase screen -->
            <div id="evolution-screen" class="screen">
                <h2>Create Phrases</h2>
                <div id="available-phrases" class="phrase-grid">
                    <!-- Available phrase combinations will appear here -->
                </div>
                <button id="back-from-evolution" class="pixel-btn">Back</button>
            </div>

            <!-- Items/Bag screen -->
            <div id="items-screen" class="screen">
                <h2>Items Bag</h2>
                <div class="items-info">
                    <p>Use items to boost your characters' XP and help them level up faster!</p>
                </div>
                <div id="items-grid" class="items-grid">
                    <!-- Items will be displayed here -->
                </div>
                <button id="items-back-btn" class="pixel-btn">‚Üê Back</button>
            </div>

            <!-- Battle screen -->
            <div id="battle-screen" class="screen">
                <h2>Battle Arena</h2>
                
                <!-- Battle area -->
                <div class="battle-area">
                    <!-- Player side -->
                    <div class="battle-side player-side">
                        <h3>Your Character</h3>
                        <div id="player-character" class="battle-character">
                            <!-- Player character will be displayed here -->
                        </div>
                        <div id="player-team" class="character-team">
                            <!-- Other available characters for switching -->
                        </div>
                    </div>

                    <!-- VS indicator -->
                    <div class="battle-vs">
                        <div class="vs-text">VS</div>
                        <button id="attack-btn" class="pixel-btn attack-btn">Attack!</button>
                    </div>

                    <!-- Enemy side -->
                    <div class="battle-side enemy-side">
                        <h3>Wild Character</h3>
                        <div id="enemy-character" class="battle-character">
                            <!-- Enemy character will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Battle log -->
                <div class="battle-log">
                    <h4>Battle Log</h4>
                    <div id="battle-messages" class="battle-messages">
                        <!-- Battle messages will appear here -->
                    </div>
                </div>

                <!-- Battle controls -->
                <div class="battle-controls">
                    <button id="battle-back-btn" class="pixel-btn">‚Üê Back to Practice</button>
                    <button id="find-opponent-btn" class="pixel-btn">Find New Opponent</button>
                </div>
            </div>
        </main>

        <!-- Character Selection Modal for Item Usage -->
        <div id="character-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Choose Character</h3>
                    <button id="modal-close" class="pixel-btn close-btn">‚úï</button>
                </div>
                <div class="modal-body">
                    <p id="modal-item-info">Select a character to use this item on:</p>
                    <div id="modal-character-grid" class="character-grid small">
                        <!-- Characters for selection will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Battle Team Selection Modal -->
        <div id="team-selection-modal" class="modal hidden">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>‚öîÔ∏è Select Battle Team</h3>
                    <button id="team-modal-close" class="pixel-btn close-btn">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="team-selection-info">
                        <p>Choose up to 6 characters for battle. Click characters to add/remove them from your team.</p>
                        <div class="team-counter">
                            <span>Team: </span>
                            <span id="selected-count">0</span>
                            <span>/</span>
                            <span id="max-count">6</span>
                        </div>
                    </div>
                    
                    <div class="selected-team">
                        <h4>Selected Team:</h4>
                        <div id="selected-team-grid" class="character-grid small">
                            <!-- Selected characters appear here -->
                        </div>
                    </div>
                    
                    <div class="available-characters">
                        <h4>Available Characters:</h4>
                        <div id="available-team-grid" class="character-grid small">
                            <!-- Available characters appear here -->
                        </div>
                    </div>
                    
                    <div class="team-selection-buttons">
                        <button id="start-battle-btn" class="pixel-btn battle-btn" disabled>Start Battle!</button>
                        <button id="cancel-team-btn" class="pixel-btn">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Examples Modal -->
        <div id="examples-modal" class="modal hidden">
            <div class="modal-content large">
                <div class="modal-header">
                    <h3>üìã JSON Format Examples</h3>
                    <button id="examples-modal-close" class="pixel-btn close-btn">‚úï</button>
                </div>
                <div class="modal-body">
                    <p>Use these formats to create your own character and phrase data files:</p>
                    
                    <div class="example-section">
                        <h4>Character Data Format</h4>
                        <pre id="character-example" class="json-example"></pre>
                        <button class="pixel-btn small-btn" id="download-char-example">üì• Download Example</button>
                    </div>
                    
                    <div class="example-section">
                        <h4>Phrase Data Format</h4>
                        <pre id="phrase-example" class="json-example"></pre>
                        <button class="pixel-btn small-btn" id="download-phrase-example">üì• Download Example</button>
                    </div>
                    
                    <div class="example-section">
                        <h4>Combined Data Format</h4>
                        <pre id="combined-example" class="json-example"></pre>
                        <button class="pixel-btn small-btn" id="download-combined-example">üì• Download Example</button>
                    </div>
                    
                    <div class="example-info">
                        <h4>Field Descriptions:</h4>
                        <ul>
                            <li><strong>pinyin</strong>: Pronunciation (required)</li>
                            <li><strong>strokes</strong>: Number of strokes (1-30, required)</li>
                            <li><strong>difficulty</strong>: Difficulty level (1-5, required)</li>
                            <li><strong>frequency</strong>: Usage frequency (0-100, required)</li>
                            <li><strong>characters</strong>: Array of characters in phrase (required for phrases)</li>
                            <li><strong>requirements</strong>: Character level requirements (required for phrases)</li>
                            <li><strong>meaning</strong>: English meaning (required for phrases)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="practice-tracker.js"></script>
    <script src="practice-ui.js"></script>
    <script src="game-data.js"></script>
    <script src="data-manager.js"></script>
    <script src="game-engine.js"></script>
    <script src="game-ui.js"></script>
    <script src="main.js"></script>
</body>
</html>
